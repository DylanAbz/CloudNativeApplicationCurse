name: Blue/Green switch only

on:
  workflow_dispatch: {}

jobs:
  switch:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine active and next color
        id: color
        shell: powershell
        run: |
          $stateRoot = Join-Path (Split-Path "${{ github.workspace }}") "_bluegreen_state"
          if (-not (Test-Path $stateRoot)) {
            New-Item -ItemType Directory -Path $stateRoot | Out-Null
          }

          $path = Join-Path $stateRoot "active_color"

          if (Test-Path $path) {
            $active = (Get-Content $path).Trim()
          } else {
            $active = "blue"
          }

          if ($active -eq "blue") { $next = "green" } else { $next = "blue" }

          Write-Host "Active color: $active"
          Write-Host "Next color: $next"

          "active=$active" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "next=$next"     | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      

      - name: Switch Nginx to next color
        shell: powershell
        run: |
          $next = "${{ steps.color.outputs.next }}"
          Copy-Item "proxy/active_upstream.$next.conf" "proxy/active_upstream.conf" -Force
          docker exec gym_proxy nginx -s reload

      - name: Update active color file
        shell: powershell
        run: |
          $stateRoot = Join-Path (Split-Path "${{ github.workspace }}") "_bluegreen_state"
          if (-not (Test-Path $stateRoot)) {
            New-Item -ItemType Directory -Path $stateRoot | Out-Null
          }

          $path = Join-Path $stateRoot "active_color"
          $next = "${{ steps.color.outputs.next }}"
          Set-Content -Path $path -Value $next
      
